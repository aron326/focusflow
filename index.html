<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusFlow Pro - ç•ªèŒ„é˜</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --primary: #ff6b6b; /* ç•ªèŒ„ç´… */
            --accent: #4ecdc4;
            --text: #ffffff;
            --secondary-text: #aaaaaa;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            transition: background 0.3s;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        /* è¨ˆæ™‚å™¨é¡¯ç¤º */
        .timer-display {
            font-size: 6rem;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
            margin: 20px 0;
            color: var(--primary);
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
        }

        /* é è¨­æŒ‰éˆ•å€ */
        .presets {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 5px;
        }

        .preset-btn {
            background: #2c2c2c;
            border: 1px solid #333;
            color: var(--text);
            padding: 10px 5px;
            border-radius: 10px;
            cursor: pointer;
            flex: 1;
            font-size: 0.8rem;
            transition: all 0.2s;
            position: relative;
        }

        .preset-btn:hover, .preset-btn.active {
            background: var(--primary);
            color: #000;
            font-weight: bold;
        }

        /* ç·¨è¼¯å°åœ–ç¤º */
        .edit-hint {
            font-size: 0.6rem;
            opacity: 0.5;
            display: block;
            margin-top: 2px;
        }

        /* æ ¸å¿ƒæ§åˆ¶æŒ‰éˆ• */
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .btn-main {
            padding: 15px 40px;
            font-size: 1.2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.1s;
        }

        .btn-start { background-color: var(--primary); color: white; }
        .btn-reset { background-color: transparent; border: 2px solid #555; color: var(--secondary-text); }
        .btn-main:active { transform: scale(0.95); }

        /* éŸ³æ¨‚æ§åˆ¶é¢æ¿ */
        .audio-panel {
            background: #252525;
            padding: 15px;
            border-radius: 15px;
            text-align: left;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .switch-group { display: flex; align-items: center; gap: 10px; }
        
        /* é ç±¤åˆ‡æ› */
        .tabs { display: flex; margin-bottom: 10px; border-bottom: 1px solid #444; }
        .tab {
            padding: 8px 15px;
            cursor: pointer;
            color: var(--secondary-text);
            border-bottom: 2px solid transparent;
        }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        /* è¼¸å…¥å€ */
        .input-group { margin-bottom: 10px; }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            background: #333;
            border: none;
            color: white;
            border-radius: 5px;
            box-sizing: border-box; 
        }
        
        /* éš±è— YouTube iframe */
        #youtube-player { display: none; }
        
        /* éŸ³é‡æ»‘æ¡¿ */
        .volume-control { display: flex; align-items: center; gap: 10px; font-size: 0.8rem; color: var(--secondary-text); }
        input[type="range"] { flex: 1; accent-color: var(--accent); }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>FocusFlow</h2>
    
    <div class="presets" id="presetContainer">
        </div>

    <div class="timer-display" id="timeDisplay">25:00</div>

    <div class="controls">
        <button class="btn-main btn-start" id="startBtn" onclick="toggleTimer()">é–‹å§‹å°ˆæ³¨</button>
        <button class="btn-main btn-reset" onclick="resetTimer()">é‡ç½®</button>
    </div>

    <div class="audio-panel">
        <div class="panel-header">
            <span>ğŸµ èƒŒæ™¯éŸ³æ¨‚</span>
            <div class="switch-group">
                <input type="checkbox" id="musicToggle" checked>
                <label for="musicToggle">å•Ÿç”¨</label>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('youtube')">YouTube</div>
            <div class="tab" onclick="switchTab('local')">æœ¬åœ°æª”æ¡ˆ</div>
        </div>

        <div id="youtubeInput" class="input-group">
            <input type="text" id="ytUrl" placeholder="è²¼ä¸Š YouTube é€£çµæˆ– Video ID" value="5L_u_hUV4Rk">
            <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                é è¨­: Tchaikovsky Andante CantabileéŸ³æ¨‚ (å¯é»æ“Šé–‹å§‹ç›´æ¥æ’­æ”¾)
            </div>
        </div>

        <div id="localInput" class="input-group hidden">
            <input type="file" id="localFile" accept="audio/*">
            <audio id="localAudioPlayer" loop></audio>
        </div>

        <div class="volume-control">
            <span>éŸ³é‡</span>
            <input type="range" id="volumeSlider" min="0" max="100" value="50">
        </div>
    </div>
</div>

<div id="player"></div>

<script>
    // --- 1. æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ ---
    let state = {
        timeLeft: 25 * 60,
        initialTime: 25 * 60,
        isRunning: false,
        timerId: null,
        currentPresetIndex: 0,
        musicSource: 'youtube', // 'youtube' or 'local'
        isMusicEnabled: true,
        presets: [
            { label: "ç•ªèŒ„é˜", minutes: 25 },
            { label: "çŸ­ä¼‘æ¯", minutes: 5 },
            { label: "é•·ä¼‘æ¯", minutes: 15 },
            { label: "æ·±åº¦å·¥ä½œ", minutes: 50 },
            { label: "è¡åˆº", minutes: 10 }
        ]
    };

    // --- 2. åˆå§‹åŒ–èˆ‡é è¨­æŒ‰éˆ•é‚è¼¯ ---
    function init() {
        renderPresets();
        updateDisplay();
        
        // ç›£è½éŸ³é‡æ”¹è®Š
        document.getElementById('volumeSlider').addEventListener('input', (e) => {
            setVolume(e.target.value);
        });

        // ç›£è½éŸ³æ¨‚é–‹é—œ
        document.getElementById('musicToggle').addEventListener('change', (e) => {
            state.isMusicEnabled = e.target.checked;
            if (!state.isMusicEnabled) pauseAudio();
            else if (state.isRunning) playAudio();
        });
    }

    function renderPresets() {
        const container = document.getElementById('presetContainer');
        container.innerHTML = '';
        state.presets.forEach((preset, index) => {
            const btn = document.createElement('div');
            btn.className = `preset-btn ${index === state.currentPresetIndex ? 'active' : ''}`;
            btn.innerHTML = `${preset.label}<br><span class="edit-hint">${preset.minutes}m (ç·¨è¼¯)</span>`;
            
            // å·¦éµé»æ“Šï¼šé¸æ“‡
            btn.onclick = () => selectPreset(index);
            
            // å³éµé»æ“Šï¼šç·¨è¼¯ (åœ¨æ‰‹æ©Ÿä¸Šå¯ç”¨é•·æŒ‰æ¨¡æ“¬ï¼Œé€™è£¡ç°¡å–®ç”¨ ContextMenu ç¤ºç¯„)
            btn.oncontextmenu = (e) => {
                e.preventDefault();
                editPreset(index);
            };

            container.appendChild(btn);
        });
    }

    function selectPreset(index) {
        if (state.isRunning) return; // åŸ·è¡Œä¸­ä¸å¯åˆ‡æ›
        state.currentPresetIndex = index;
        state.initialTime = state.presets[index].minutes * 60;
        state.timeLeft = state.initialTime;
        renderPresets();
        updateDisplay();
    }

    function editPreset(index) {
        const p = state.presets[index];
        const newLabel = prompt("è¼¸å…¥æ–°çš„æ¨™ç±¤åç¨±:", p.label);
        const newTime = prompt("è¼¸å…¥æ–°çš„åˆ†é˜æ•¸:", p.minutes);

        if (newLabel && newTime && !isNaN(newTime)) {
            state.presets[index] = { label: newLabel, minutes: parseInt(newTime) };
            // å¦‚æœç•¶å‰é¸ä¸­çš„æ˜¯è¢«ç·¨è¼¯çš„ï¼Œå³æ™‚æ›´æ–°
            if (state.currentPresetIndex === index) {
                selectPreset(index);
            } else {
                renderPresets();
            }
        }
    }

    // --- 3. è¨ˆæ™‚å™¨é‚è¼¯ ---
    function updateDisplay() {
        const m = Math.floor(state.timeLeft / 60);
        const s = state.timeLeft % 60;
        document.getElementById('timeDisplay').innerText = 
            `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        document.title = `(${m}:${s}) FocusFlow`;
    }

    function toggleTimer() {
        const btn = document.getElementById('startBtn');
        
        if (state.isRunning) {
            // æš«åœ
            clearInterval(state.timerId);
            state.isRunning = false;
            btn.innerText = "ç¹¼çºŒ";
            btn.style.backgroundColor = "#4ecdc4"; // è®Šè‰²
            pauseAudioWithFade(); // æ¼¸å‡ºæš«åœ
        } else {
            // é–‹å§‹
            if (state.timeLeft === 0) return; // å·²çµæŸ
            state.isRunning = true;
            btn.innerText = "æš«åœ";
            btn.style.backgroundColor = "#ff6b6b";
            
            loadAndPlayAudio(); // æ’­æ”¾éŸ³æ¨‚
            
            state.timerId = setInterval(() => {
                state.timeLeft--;
                updateDisplay();
                
                if (state.timeLeft <= 0) {
                    timerFinished();
                }
            }, 1000);
        }
    }

    function resetTimer() {
        clearInterval(state.timerId);
        state.isRunning = false;
        state.timeLeft = state.initialTime;
        updateDisplay();
        document.getElementById('startBtn').innerText = "é–‹å§‹å°ˆæ³¨";
        pauseAudio(); // ç›´æ¥åœæ­¢ï¼Œä¸éœ€æ¼¸å‡º
        resetAudioPosition(); // é‡ç½®éŸ³æ¨‚åˆ°é–‹é ­
    }

    function timerFinished() {
        clearInterval(state.timerId);
        state.isRunning = false;
        document.getElementById('startBtn').innerText = "é–‹å§‹å°ˆæ³¨";
        
        // 1. æ¼¸å‡ºåœæ­¢éŸ³æ¨‚
        pauseAudioWithFade();
        
        // 2. æ’­æ”¾é¬§é˜éŸ³æ•ˆ (ä½¿ç”¨ Oscillator ç”¢ç”Ÿç°¡å–®çš„å—¶å—¶è²ï¼Œç„¡éœ€å¤–éƒ¨æª”æ¡ˆ)
        playAlarmSound();
        
        alert("æ™‚é–“åˆ°ï¼å°ˆæ³¨å®Œæˆï¼");
    }

    // --- 4. éŸ³è¨Šå¼•æ“ (YouTube API & Local) ---
    
    // YouTube API Setup
    var player;
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '0',
            width: '0',
            videoId: '5L_u_hUV4Rk', // é è¨­ Tchaikovsky Andante Cantabile
            playerVars: {
                'playsinline': 1,
                'loop': 1, // å¾ªç’°æ’­æ”¾
                'controls': 0
            },
            events: {
                'onReady': onPlayerReady
            }
        });
    }

    function onPlayerReady(event) {
        // è¨­å®šåˆå§‹éŸ³é‡
        event.target.setVolume(document.getElementById('volumeSlider').value);
    }

    // è¼‰å…¥ YouTube SDK
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    // åˆ‡æ›ä¾†æº UI
    function switchTab(source) {
        state.musicSource = source;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        if (source === 'youtube') {
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.getElementById('youtubeInput').classList.remove('hidden');
            document.getElementById('localInput').classList.add('hidden');
        } else {
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.getElementById('youtubeInput').classList.add('hidden');
            document.getElementById('localInput').classList.remove('hidden');
        }
    }

    // éŸ³è¨Šæ§åˆ¶æ ¸å¿ƒ
    function loadAndPlayAudio() {
        if (!state.isMusicEnabled) return;

        const volume = document.getElementById('volumeSlider').value;

        if (state.musicSource === 'youtube') {
            // è™•ç† YouTube ID
            let inputUrl = document.getElementById('ytUrl').value;
            let videoId = extractVideoID(inputUrl);
            
            if (player && videoId) {
                // å¦‚æœæ˜¯æ–° IDï¼Œè¼‰å…¥æ–°å½±ç‰‡
                if (player.getVideoData()['video_id'] !== videoId) {
                    player.loadVideoById(videoId);
                }
                player.setVolume(volume);
                player.playVideo();
            }
        } else {
            // è™•ç†æœ¬åœ°æª”æ¡ˆ
            const localPlayer = document.getElementById('localAudioPlayer');
            const fileInput = document.getElementById('localFile');
            
            if (fileInput.files.length > 0) {
                if (!localPlayer.src || localPlayer.src === "") {
                    localPlayer.src = URL.createObjectURL(fileInput.files[0]);
                }
                localPlayer.volume = volume / 100;
                
                // æ¼¸å…¥æ•ˆæœ (Fade In)
                localPlayer.volume = 0;
                localPlayer.play();
                let vol = 0;
                let fadeInterval = setInterval(() => {
                    if (vol >= volume / 100) clearInterval(fadeInterval);
                    else {
                        vol += 0.05;
                        localPlayer.volume = Math.min(vol, volume/100);
                    }
                }, 100);
            }
        }
    }

    function pauseAudio() {
        if (player && typeof player.pauseVideo === 'function') player.pauseVideo();
        document.getElementById('localAudioPlayer').pause();
    }

    function resetAudioPosition() {
        // YouTube API doesn't allow seek unless playing, so we skip for now or seek on next play
        const localPlayer = document.getElementById('localAudioPlayer');
        if(!localPlayer.paused) localPlayer.pause();
        localPlayer.currentTime = 0;
    }

    // åŠ åˆ†åŠŸèƒ½ï¼šæ¼¸å‡º (Fade Out)
    function pauseAudioWithFade() {
        if (state.musicSource === 'youtube' && player) {
            let currentVol = player.getVolume();
            let fadeOut = setInterval(() => {
                currentVol -= 5;
                if (currentVol <= 0) {
                    clearInterval(fadeOut);
                    player.pauseVideo();
                    player.setVolume(document.getElementById('volumeSlider').value); // æ¢å¾©éŸ³é‡è¨­å®šä¾›ä¸‹æ¬¡ä½¿ç”¨
                } else {
                    player.setVolume(currentVol);
                }
            }, 100);
        } else {
            const localPlayer = document.getElementById('localAudioPlayer');
            let currentVol = localPlayer.volume;
            let fadeOut = setInterval(() => {
                currentVol -= 0.05;
                if (currentVol <= 0) {
                    clearInterval(fadeOut);
                    localPlayer.pause();
                    localPlayer.volume = document.getElementById('volumeSlider').value / 100;
                } else {
                    localPlayer.volume = Math.max(0, currentVol);
                }
            }, 100);
        }
    }

    function setVolume(val) {
        if (player && typeof player.setVolume === 'function') player.setVolume(val);
        const localPlayer = document.getElementById('localAudioPlayer');
        localPlayer.volume = val / 100;
    }

    // å·¥å…·ï¼šæå– YouTube ID
    function extractVideoID(url) {
        var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
        var match = url.match(regExp);
        return (match && match[7].length == 11) ? match[7] : url; // å¦‚æœæœ¬èº«å°±æ˜¯ ID å‰‡å›å‚³ï¼Œå¦å‰‡å˜—è©¦è§£æ
    }

    // å·¥å…·ï¼šç”¢ç”Ÿé¬§é˜å—¶å—¶è² (Web Audio API)
    function playAlarmSound() {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        
        const ctx = new AudioContext();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();

        osc.connect(gain);
        gain.connect(ctx.destination);

        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, ctx.currentTime); // A5
        osc.frequency.setValueAtTime(440, ctx.currentTime + 0.5); // A4
        
        gain.gain.setValueAtTime(0.5, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1);

        osc.start();
        osc.stop(ctx.currentTime + 1);
    }

    // å•Ÿå‹•
    init();

</script>

</body>
</html>


