<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusFlow v3.0</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --primary: #ff6b6b;  /* å·¥ä½œç´… */
            --break: #4ecdc4;    /* ä¼‘æ¯ç¶  */
            --text: #ffffff;
            --sub-text: #888888;
            --ring-bg: #2a2a2a;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
        }

        /* ä¸»é¢æ¿ */
        .dashboard {
            background-color: var(--card-bg);
            padding: 2.5rem;
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            width: 90%;
            max-width: 450px;
            text-align: center;
            position: relative;
        }

        /* 1. æ—¥æœŸæ™‚é–“é¡¯ç¤º */
        .status-bar {
            font-size: 0.9rem;
            color: var(--sub-text);
            margin-bottom: 20px;
            font-weight: 500;
            letter-spacing: 1px;
        }

        /* 4. ä»»å‹™è¼¸å…¥æ¬„ */
        .task-input-group {
            margin-bottom: 20px;
        }
        .task-input {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 2px solid #333;
            color: var(--text);
            font-size: 1.3rem;
            text-align: center;
            padding: 8px;
            outline: none;
            transition: all 0.3s;
        }
        .task-input:focus {
            border-bottom-color: var(--primary);
        }
        .task-input::placeholder { color: #444; }

        /* 2. è¦–è¦ºåŒ–åœ–å½¢é€²åº¦æ¢ (SVG) */
        .timer-wrapper {
            position: relative;
            width: 260px;
            height: 260px;
            margin: 0 auto 25px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timer-svg {
            transform: rotate(-90deg); /* å¾æ­£ä¸Šæ–¹é–‹å§‹ */
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
        }

        .circle-bg {
            fill: none;
            stroke: var(--ring-bg);
            stroke-width: 8;
        }

        .circle-progress {
            fill: none;
            stroke: var(--primary);
            stroke-width: 8;
            stroke-linecap: round; /* åœ“é ­ */
            stroke-dasharray: 754; /* 2 * PI * 120 */
            stroke-dashoffset: 0;
            transition: stroke-dashoffset 1s linear, stroke 0.3s;
            filter: drop-shadow(0 0 4px var(--primary)); /* ç™¼å…‰æ•ˆæœ */
        }

        /* æ™‚é–“æ•¸å­— */
        .timer-display {
            z-index: 10;
            font-size: 4.5rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            text-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .presets {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .preset-btn {
            background: #2c2c2c;
            border: 1px solid #333;
            color: #ccc;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: 0.2s;
        }
        .preset-btn:hover, .preset-btn.active {
            background: var(--text);
            color: var(--bg-color);
            font-weight: bold;
        }

        .controls { display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; }
        .btn-main {
            padding: 12px 40px;
            font-size: 1.1rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.1s;
        }
        .btn-start { background-color: var(--primary); color: white; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4); }
        .btn-reset { background-color: transparent; border: 2px solid #444; color: #888; }
        .btn-main:active { transform: scale(0.96); }

        /* éŸ³æ¨‚é¢æ¿ (ç²¾ç°¡åŒ–) */
        .audio-panel {
            background: #181818;
            padding: 15px;
            border-radius: 12px;
            text-align: left;
            border: 1px solid #333;
        }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.9rem; color: #aaa; }
        .switch-group { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        
        .tabs { display: flex; margin-bottom: 10px; border-bottom: 1px solid #333; }
        .tab { padding: 6px 12px; cursor: pointer; color: #666; font-size: 0.85rem; border-bottom: 2px solid transparent; }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }

        input[type="text"] { width: 100%; padding: 8px; background: #2a2a2a; border: none; color: white; border-radius: 4px; box-sizing: border-box; }
        
        .hidden { display: none; }
        input[type="range"] { width: 100%; accent-color: var(--primary); height: 4px; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="status-bar" id="dateTime">Loading date...</div>

    <div class="task-input-group">
        <input type="text" class="task-input" id="taskName" placeholder="âœ¨ è¼¸å…¥ç•¶å‰å°ˆæ³¨ä»»å‹™..." oninput="updateTitle()">
    </div>

    <div class="timer-wrapper">
        <svg class="timer-svg" viewBox="0 0 250 250">
            <circle class="circle-bg" cx="125" cy="125" r="120"></circle>
            <circle class="circle-progress" id="progressRing" cx="125" cy="125" r="120"></circle>
        </svg>
        <div class="timer-display" id="timeDisplay">25:00</div>
    </div>
    
    <div class="presets" id="presetContainer"></div>

    <div class="controls">
        <button class="btn-main btn-start" id="startBtn" onclick="toggleTimer()">é–‹å§‹</button>
        <button class="btn-main btn-reset" onclick="resetTimer()">é‡ç½®</button>
    </div>

    <div class="audio-panel">
        <div class="panel-header">
            <span>ğŸ§ èƒŒæ™¯éŸ³æ¨‚</span>
            <div class="switch-group">
                <input type="checkbox" id="musicToggle" checked> <label for="musicToggle">é–‹å•Ÿ</label>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('youtube')">YouTube</div>
            <div class="tab" onclick="switchTab('local')">æœ¬åœ°æª”æ¡ˆ</div>
        </div>

        <div id="youtubeInput">
            <input type="text" id="ytUrl" placeholder="YouTube URL / ID" value="jfKfPfyJRdk">
        </div>
        <div id="localInput" class="hidden">
            <input type="file" id="localFile" accept="audio/*">
            <audio id="localAudioPlayer" loop></audio>
        </div>
        <div style="margin-top:10px; display:flex; gap:10px; color:#666; font-size:0.8rem; align-items:center;">
            <span>éŸ³é‡</span>
            <input type="range" id="volumeSlider" min="0" max="100" value="50">
        </div>
    </div>
</div>

<div id="player"></div>

<script>
    // --- APP ç‹€æ…‹ ---
    let state = {
        timeLeft: 25 * 60,
        initialTime: 25 * 60,
        isRunning: false,
        timerId: null,
        currentPresetIndex: 0,
        musicSource: 'youtube', 
        isMusicEnabled: true,
        presets: [
            { label: "ç•ªèŒ„é˜", minutes: 25, type: 'work' },
            { label: "çŸ­ä¼‘æ¯", minutes: 5, type: 'break' },
            { label: "é•·ä¼‘æ¯", minutes: 15, type: 'break' },
            { label: "æ·±åº¦å·¥ä½œ", minutes: 50, type: 'work' },
            { label: "æ”¶å°¾", minutes: 10, type: 'work' }
        ]
    };

    // --- åˆå§‹åŒ– ---
    function init() {
        renderPresets();
        updateDisplay();
        startClock(); // å•Ÿå‹•æ™‚é˜
        
        // éŸ³æ¨‚èˆ‡éŸ³é‡ç›£è½
        document.getElementById('volumeSlider').addEventListener('input', (e) => setVolume(e.target.value));
        document.getElementById('musicToggle').addEventListener('change', (e) => {
            state.isMusicEnabled = e.target.checked;
            if (!state.isMusicEnabled) pauseAudio();
            else if (state.isRunning) loadAndPlayAudio();
        });

        // è«‹æ±‚é€šçŸ¥æ¬Šé™ (ç•¶ä½¿ç”¨è€…ç¬¬ä¸€æ¬¡äº’å‹•æ™‚ä¹Ÿæœƒå†æ¬¡è«‹æ±‚)
        if ("Notification" in window && Notification.permission !== "granted") {
            // éœé»˜æª¢æŸ¥ï¼Œä¸ç›´æ¥å½ˆçª—ï¼Œç­‰åˆ°æŒ‰æŒ‰éˆ•å†å½ˆ
        }
    }

    // --- 1. æ—¥æœŸæ™‚é–“åŠŸèƒ½ ---
    function startClock() {
        function updateTime() {
            const now = new Date();
            // æ ¼å¼ï¼š2023/10/27 é€±äº” 14:30:05
            const dateStr = now.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short' });
            const timeStr = now.toLocaleTimeString('zh-TW', { hour12: false });
            document.getElementById('dateTime').innerText = `${dateStr} â€¢ ${timeStr}`;
        }
        updateTime();
        setInterval(updateTime, 1000);
    }

    // --- 4. ä»»å‹™æ¨™é¡Œæ›´æ–° ---
    function updateTitle() {
        const m = Math.floor(state.timeLeft / 60);
        const s = state.timeLeft % 60;
        const timeStr = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        const task = document.getElementById('taskName').value;
        const label = task ? task : "FocusFlow";
        
        // å¦‚æœæ­£åœ¨è·‘ï¼Œé¡¯ç¤ºæ™‚é–“ï¼›æ²’è·‘å‰‡é¡¯ç¤º FocusFlow
        document.title = state.isRunning ? `(${timeStr}) ${label}` : `${label} - æº–å‚™ä¸­`;
    }

    // --- æ¸²æŸ“èˆ‡æ“ä½œ ---
    function renderPresets() {
        const container = document.getElementById('presetContainer');
        container.innerHTML = '';
        state.presets.forEach((preset, index) => {
            const btn = document.createElement('div');
            btn.className = `preset-btn ${index === state.currentPresetIndex ? 'active' : ''}`;
            btn.innerText = preset.label;
            btn.onclick = () => selectPreset(index);
            btn.oncontextmenu = (e) => { e.preventDefault(); editPreset(index); };
            container.appendChild(btn);
        });
    }

    function selectPreset(index) {
        if (state.isRunning) return;
        state.currentPresetIndex = index;
        const p = state.presets[index];
        state.initialTime = p.minutes * 60;
        state.timeLeft = state.initialTime;
        
        // è®Šè‰²é‚è¼¯ï¼šä¼‘æ¯è®Šç¶ è‰²ï¼Œå·¥ä½œè®Šç´…è‰²
        const color = p.type === 'break' ? '#4ecdc4' : '#ff6b6b';
        document.documentElement.style.setProperty('--primary', color);
        
        renderPresets();
        updateDisplay();
        updateRing();
    }

    function editPreset(index) {
        const p = state.presets[index];
        const label = prompt("åç¨±", p.label);
        const min = prompt("åˆ†é˜", p.minutes);
        if (label && min && !isNaN(min)) {
            state.presets[index].label = label;
            state.presets[index].minutes = parseInt(min);
            if (state.currentPresetIndex === index) selectPreset(index);
            else renderPresets();
        }
    }

    // --- 2. è¨ˆæ™‚å™¨èˆ‡ SVG é€²åº¦æ¢ ---
    function updateDisplay() {
        const m = Math.floor(state.timeLeft / 60);
        const s = state.timeLeft % 60;
        document.getElementById('timeDisplay').innerText = 
            `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        updateTitle();
    }

    function updateRing() {
        // åœ“å‘¨é•· = 2 * PI * 120 â‰ˆ 754
        const circle = document.getElementById('progressRing');
        const total = 754;
        const offset = total - (state.timeLeft / state.initialTime) * total;
        circle.style.strokeDashoffset = offset;
    }

    function toggleTimer() {
        const btn = document.getElementById('startBtn');
        
        // 3. å˜—è©¦è«‹æ±‚é€šçŸ¥æ¬Šé™
        if (Notification.permission === "default") Notification.requestPermission();

        if (state.isRunning) {
            clearInterval(state.timerId);
            state.isRunning = false;
            btn.innerText = "ç¹¼çºŒ";
            btn.style.opacity = "0.7";
            pauseAudioWithFade();
        } else {
            if (state.timeLeft <= 0) return;
            state.isRunning = true;
            btn.innerText = "æš«åœ";
            btn.style.opacity = "1";
            loadAndPlayAudio();
            
            state.timerId = setInterval(() => {
                state.timeLeft--;
                updateDisplay();
                updateRing();
                if (state.timeLeft <= 0) timerFinished();
            }, 1000);
        }
        updateTitle();
    }

    function resetTimer() {
        clearInterval(state.timerId);
        state.isRunning = false;
        state.timeLeft = state.initialTime;
        updateDisplay();
        updateRing();
        document.getElementById('startBtn').innerText = "é–‹å§‹";
        pauseAudio();
        resetAudioPosition();
    }

    function timerFinished() {
        clearInterval(state.timerId);
        state.isRunning = false;
        document.getElementById('startBtn').innerText = "é–‹å§‹";
        pauseAudioWithFade();
        playAlarmSound();
        sendNotification(); // ç™¼é€é€šçŸ¥
        updateTitle();
        alert("ğŸ‰ æ™‚é–“åˆ°ï¼è©²éšæ®µçµæŸï¼");
    }

    // --- 3. æ¡Œé¢é€šçŸ¥åŠŸèƒ½ ---
    function sendNotification() {
        if (Notification.permission === "granted") {
            const task = document.getElementById('taskName').value || "å°ˆæ³¨æ™‚æ®µ";
            new Notification("â° FocusFlow æ™‚é–“åˆ°ï¼", {
                body: `æ‚¨å‰›å‰›å®Œæˆäº†ï¼š${task}\nèµ·ä¾†èµ°å‹•ä¸€ä¸‹å§ï¼`,
                icon: "https://cdn-icons-png.flaticon.com/512/3209/3209931.png" // ç•ªèŒ„ icon
            });
        }
    }

    // --- éŸ³è¨Šå¼•æ“ (YouTube ä¿®å¾© + å¾ªç’°) ---
    var player;
    function onYouTubeIframeAPIReady() {
        const id = extractVideoID(document.getElementById('ytUrl').value) || 'jfKfPfyJRdk';
        player = new YT.Player('player', {
            height: '0', width: '0', videoId: id,
            playerVars: { 'playsinline': 1, 'controls': 0, 'rel': 0 },
            events: {
                'onReady': (e) => e.target.setVolume(document.getElementById('volumeSlider').value),
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerStateChange(event) {
        if (event.data === 0) { // çµæŸæ™‚å¼·åˆ¶é‡æ’­
            player.seekTo(0);
            player.playVideo();
        }
    }
    
    // è¼‰å…¥ YouTube API
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    function switchTab(source) {
        state.musicSource = source;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        if (source === 'youtube') {
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.getElementById('youtubeInput').classList.remove('hidden');
            document.getElementById('localInput').classList.add('hidden');
        } else {
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.getElementById('youtubeInput').classList.add('hidden');
            document.getElementById('localInput').classList.remove('hidden');
        }
    }

    function loadAndPlayAudio() {
        if (!state.isMusicEnabled) return;
        const volume = document.getElementById('volumeSlider').value;

        try {
            if (state.musicSource === 'youtube') {
                if (!player || typeof player.playVideo !== 'function') return;
                let id = extractVideoID(document.getElementById('ytUrl').value);
                if (id && player.getVideoData && player.getVideoData()['video_id'] !== id) {
                    player.loadVideoById(id);
                }
                player.setVolume(volume);
                player.playVideo();
            } else {
                const lp = document.getElementById('localAudioPlayer');
                const file = document.getElementById('localFile').files[0];
                if (file && !lp.src) lp.src = URL.createObjectURL(file);
                if (file || lp.src) {
                    lp.volume = 0;
                    lp.play();
                    let v = 0, t = volume/100;
                    let fade = setInterval(() => {
                        if (v >= t) clearInterval(fade);
                        else { v+=0.05; lp.volume = Math.min(v,t); }
                    }, 100);
                }
            }
        } catch(e) { console.error(e); }
    }

    function pauseAudio() {
        if (player && typeof player.pauseVideo === 'function') player.pauseVideo();
        document.getElementById('localAudioPlayer').pause();
    }

    function pauseAudioWithFade() {
        if (state.musicSource === 'youtube' && player) {
            let vol = player.getVolume();
            let fade = setInterval(() => {
                vol -= 5;
                if (vol <= 0) { clearInterval(fade); player.pauseVideo(); player.setVolume(document.getElementById('volumeSlider').value); }
                else player.setVolume(vol);
            }, 100);
        } else {
            const lp = document.getElementById('localAudioPlayer');
            let vol = lp.volume;
            let fade = setInterval(() => {
                vol -= 0.05;
                if (vol <= 0) { clearInterval(fade); lp.pause(); lp.volume = document.getElementById('volumeSlider').value/100; }
                else lp.volume = Math.max(0, vol);
            }, 100);
        }
    }

    function resetAudioPosition() {
        const lp = document.getElementById('localAudioPlayer');
        if(!lp.paused) lp.pause();
        lp.currentTime = 0;
    }

    function setVolume(val) {
        if (player && typeof player.setVolume === 'function') player.setVolume(val);
        document.getElementById('localAudioPlayer').volume = val / 100;
    }

    function extractVideoID(url) {
        if (!url) return null;
        var match = url.match(/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/);
        return (match && match[7].length == 11) ? match[7] : url;
    }

    // é€£ç’°é¬§é˜
    function playAlarmSound() {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        const ctx = new AudioContext();
        const now = ctx.currentTime;
        function beep(t) {
            const osc = ctx.createOscillator();
            const g = ctx.createGain();
            osc.connect(g); g.connect(ctx.destination);
            osc.frequency.value = 880;
            g.gain.setValueAtTime(0.3, t);
            g.gain.exponentialRampToValueAtTime(0.01, t+0.15);
            osc.start(t); osc.stop(t+0.15);
        }
        [0,0.2,0.4, 1.2,1.4,1.6, 2.4,2.6,2.8].forEach(dt => beep(now+dt));
    }

    init();
</script>
</body>
</html>




